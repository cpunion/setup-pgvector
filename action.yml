name: 'Setup pgvector'
description: 'Setup pgvector extension for PostgreSQL'
inputs:
  postgres-version:
    description: 'PostgreSQL version to use'
    required: false
    default: '17'
  pgvector-version:
    description: 'pgvector version to install'
    required: false
    default: '0.8.0'
runs:
  using: "composite"
  steps:
    - name: Install pgvector on Ubuntu
      if: runner.os == 'Linux'
      shell: bash
      run: |
        sudo /usr/share/postgresql-common/pgdg/apt.postgresql.org.sh -y
        sudo apt-get update
        sudo apt-get install -y postgresql-${{ inputs.postgres-version }}-pgvector
        # If package not available, build from source
        if [ $? -ne 0 ]; then
          sudo apt-get install -y postgresql-server-dev-${{ inputs.postgres-version }} build-essential git
          git clone --branch v${{ inputs.pgvector-version }} https://github.com/pgvector/pgvector.git
          cd pgvector
          make
          sudo make install
          cd ..
          rm -rf pgvector
        fi

    - name: Install pgvector on macOS
      if: runner.os == 'macOS'
      shell: bash
      run: |
        brew install pgvector

    - name: Install pgvector on Windows 2022
      if: runner.os == 'Windows' && matrix.os != 'windows-2019'
      shell: cmd
      run: |
        call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat"
        cd %TEMP%
        git clone --branch v${{ inputs.pgvector-version }} https://github.com/pgvector/pgvector.git
        cd pgvector
        nmake /NOLOGO /F Makefile.win
        nmake /NOLOGO /F Makefile.win install

    - name: Install pgvector on Windows 2019
      if: runner.os == 'Windows' && matrix.os == 'windows-2019'
      shell: cmd
      run: |
        call "C:\Program Files (x86)\Microsoft Visual Studio\2019\Enterprise\VC\Auxiliary\Build\vcvars64.bat"
        cd %TEMP%
        git clone --branch v${{ inputs.pgvector-version }} https://github.com/pgvector/pgvector.git
        cd pgvector
        nmake /NOLOGO /F Makefile.win
        nmake /NOLOGO /F Makefile.win install
